<?php if ($block->isEnabled() && $block->getApiKey()): ?>
    <?php
        $userInfo = $block->getUserInfo(); // Returns ['role' => guest/customer/admin, ...]
        $queryParams = http_build_query([
            'apiKey' => $block->getApiKey(),
            'position' => $block->getPosition(),
            'theme' => 'light',
            'primaryColor' => $block->getThemeColor(),
            'headerColor'  => $block->getHeaderColor(),
            'storeLogo'    => $block->getStoreLogo(),
            'chatbotassistInit'    => $block->getFrontendGreetingMessage(),
            'userEmail' => $userInfo['email'] ?? '',
            'role' => $userInfo['role'],
        ]);
    ?>

    <style>
        #dbtalker-widget {
            position: fixed;
            <?php if ($block->getPosition() == 'left'): ?>
                left: 20px;
            <?php else: ?>
                right: 20px;
            <?php endif; ?>
            bottom: 20px;
            width: 400px;
            height: 500px;
            border: none;
            z-index: 9999;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            transition: height 0.3s ease;
            background: white;
        }

        #dbtalker-widget.minimized {
            height: 50px !important;
        }
    </style>

    <iframe
        id="dbtalker-widget"
        src="http://localhost:3001/widget?<?= $queryParams ?>"
        data-role="<?= $userInfo['role'] ?>"
        data-user-email="<?= $userInfo['email'] ?? '' ?>">
    </iframe>

    <script>
        (function() {
            const iframe = document.getElementById('dbtalker-widget');
            let isMinimized = false;

            // Send user info to iframe after it loads
            iframe.onload = function () {
                iframe.contentWindow.postMessage({
                    type: 'USER_INFO',
                    role: iframe.dataset.role,
                    email: iframe.dataset.userEmail
                }, '*');
            };

            window.addEventListener('message', function(event) {
                if (event.origin !== 'http://localhost:3001' &&
                    event.origin !== 'https://widget.dbtalker.com') {
                    return;
                }

                if (event.data.type === 'RESIZE_WIDGET') {
                    const newHeight = event.data.height + 'px';
                    const minimized = event.data.minimized;

                    iframe.style.height = newHeight;

                    if (minimized) {
                        iframe.classList.add('minimized');
                    } else {
                        iframe.classList.remove('minimized');
                    }

                    isMinimized = minimized;

                    console.log('DBTalker Magento: Iframe resized to', newHeight, 'minimized:', minimized);
                }

                if (event.data.type === 'CLOSE_WIDGET') {
                    iframe.style.display = 'none';
                    console.log('DBTalker Magento: Widget closed');
                }
            });

            window.showDBTalkerWidget = function () {
                iframe.style.display = 'block';
                if (isMinimized) {
                    iframe.style.height = '50px';
                    iframe.classList.add('minimized');
                } else {
                    iframe.style.height = '500px';
                    iframe.classList.remove('minimized');
                }
            };

            console.log('DBTalker Magento: Widget integration loaded');
        })();
    </script>
<?php endif; ?>
